RDP Reaper technical architecture specification

Goals and non goals

1.1 Goals

Run as a Windows Service and continuously monitor RDP authentication activity.

Detect and block brute force attempts by IP and by subnet.

Provide a modern Windows GUI for visibility and control.

Apply blocks using Windows Defender Firewall in a scalable way.

Enrich attacker IPs with geo and ASN data using ipwhois.io with caching.

Support country blocking and allow lists.

Remain stable when ipwhois.io is unavailable or rate limited and never crash or stall the service.

Provide a localhost only API for GUI communication.

1.2 Non goals

Remote management from other machines in v1.

Full SIEM replacement or EDR style endpoint telemetry.

Blocking at router perimeter.

High level architecture

2.1 Components

RDP Reaper Service
.NET 8 Worker Service running as a Windows Service

RDP Reaper Local API
ASP.NET Core minimal API hosted inside the service process
Bound to 127.0.0.1 only

RDP Reaper GUI
WinUI 3 desktop application
Communicates only with localhost API

Local datastore
SQLite database in a protected folder

2.2 Data flow

Service subscribes to Security Event Log.

For each relevant event, service extracts IP, username, logon type, status, and timestamp.

Service updates rolling counters for IP and subnet windows.

If thresholds are exceeded, service creates a ban record and updates firewall.

Service queues IP enrichment to the Geo Enrichment Worker.

GUI reads status, bans, and logs via localhost API and can issue commands such as unban.

Technology choices

3.1 Language and runtime

C# .NET 8

3.2 Windows log ingestion

EventLogWatcher with an XPath query against Microsoft Windows Security Auditing events

Fallback option for polling using EventLogReader if watcher subscription fails

3.3 GUI framework

WinUI 3 with MVVM pattern

Optional: Windows App SDK and CommunityToolkit MVVM

3.4 Logging

Serilog structured logging to rolling files

Optional: Windows Event Log provider for service level events

3.5 Database

SQLite using Microsoft.Data.Sqlite or EF Core with SQLite provider

WAL mode enabled for concurrent reads from GUI

Service design

4.1 Service responsibilities

Event ingestion and parsing

Detection logic and policy evaluation

Firewall rule management

Ban lifecycle management including expiry and persistence

Geo enrichment and caching with ipwhois.io

Local API hosting

Health monitoring and self recovery behavior

4.2 Internal service modules

EventIngestor
Subscribes to Security Log and emits normalized Attempt events

AttemptNormalizer
Extracts fields and validates IP address and logon type

PolicyEngine
Evaluates thresholds and creates Ban decisions

CountersStore
Maintains rolling windows for IP and subnet and optional username spray

BanManager
Creates and expires bans and persists to database

FirewallManager
Applies bans into Windows Defender Firewall efficiently

GeoEnrichmentWorker
Background queue that resolves IP metadata and updates cache

ApiHost
Localhost only REST API for GUI

4.3 Event ingestion details
4.3.1 Primary event

Event ID 4625 failed logon

Filter logon type 10 for RDP

Capture source network address, target username, status and substatus, workstation name if present

4.3.2 Optional events for correlation

Event ID 4624 successful logon, logon type 10
Used to reset counters or add allow decisions if desired

Detection and policy engine

5.1 Core concepts

Attempt
A normalized record from Security Log containing Time, IP, Username, Outcome, LogonType

Counter window
Sliding window of attempts for a key such as IP or subnet

Ban decision
A record that indicates IP ban or subnet ban or country ban applied

5.2 Configurable thresholds

IpFailureThreshold

IpWindowSeconds

IpBanDurationSeconds

SubnetFailureThreshold

SubnetWindowSeconds

SubnetBanDurationSeconds

Optional: UsernameSprayThreshold and WindowSeconds

Optional: LowAndSlowThreshold and WindowSeconds

5.3 Subnet logic

SubnetKey is IPv4 /24 by default
Example 203.0.113.77 maps to 203.0.113.0/24

Track unique IP count and total failure count per subnet window

Trigger subnet ban if total failures exceed threshold and unique IP count exceeds a minimum value
This avoids banning a subnet due to one noisy host

5.4 Country blocking policy

CountryBlockList
Any IP resolved to a blocked country triggers immediate ban

CountryAllowList
If defined, only allowed countries are permitted and others are blocked

Unknown country behavior
If geo data is unavailable, treat as Unknown and do not auto block by country
The system can optionally apply a stricter policy but default should be safe

5.5 Allow controls

AllowIpList

AllowSubnetList

AllowAsnList optional

AllowCountries optional
Allow rules always win over block rules except manual bans explicitly marked as force.

Firewall management strategy

6.1 Requirements

Must scale to thousands of blocked IPs without creating thousands of rules

Must be resilient if firewall commands fail

Must be idempotent

6.2 Implementation approach

Maintain one inbound rule for RDP traffic that blocks remote addresses in a dynamic set

Maintain one optional rule per subnet ban category if you need separation

Update the rule remote address list in batches at a fixed cadence such as every 5 seconds or when dirty flag is set

6.3 Practical constraints and batching

Windows firewall remote address field has practical size limits

When list grows large, split across multiple rules
Example RDP Reaper Block List 001, 002, 003

Rule partitioning strategy
Fixed maximum addresses per rule and stable hashing assignment so updates are minimal

6.4 Rule scope

Only target the RDP listening port 3389 by default

Optional: apply to all inbound if you want a broader block list, but default should be scoped

Local API design

7.1 Binding and access

Bind only to 127.0.0.1

Additionally verify request remote endpoint is loopback

Require an API auth token for GUI calls
Token stored in LocalMachine registry or protected file with ACL

Support optional Windows authentication if you want later, but token is simplest

7.2 Endpoint categories

Status and health
GET /api/status
GET /api/health

Attempts and analytics
GET /api/attempts with filters
GET /api/stats summary metrics

Bans
GET /api/bans active and historical
POST /api/bans add manual ban for IP or subnet or country
POST /api/bans unban by id
POST /api/bans make permanent

Allow lists and policy
GET /api/policy
PUT /api/policy update thresholds and lists

Logs
GET /api/logs tail and search
GET /api/logfiles list

7.3 API response models

Ban record includes
BanId, BanType, Key, CreatedAt, ExpiresAt nullable, Permanent bool, Reason, SourcePolicy

Attempt record includes
AttemptId, Time, IP, Subnet, Username, Outcome, LogonType, Status, EventId

Geo record includes
IP, CountryCode, Country, Region, City, ASN, ISP, Latitude, Longitude, LastUpdated

GUI design

8.1 UI goals

Fast and readable

Real time updates without heavy polling

Safe control actions with confirmation and audit log

8.2 Pages

Dashboard
Key metrics, recent attempts, active bans, top subnets, top countries

Bans
Table view with filter, unban, make permanent, add manual ban

Attempts
Search and filter attempts by IP, subnet, username, time range

Countries and policy
Manage block list and allow list, view country stats

Logs
View service logs and export

8.3 Update mechanism

Option A long polling

Option B server sent events on localhost

Option C periodic refresh every 2 seconds
Default to periodic refresh first for simplicity, then move to SSE if needed.

Database schema

9.1 Tables

Attempts
AttemptId, Time, IP, Subnet, Username, Outcome, LogonType, Status, EventId

CountersSnapshots optional
For debugging and visualization

Bans
BanId, BanType, Key, CreatedAt, ExpiresAt, Permanent, Reason, SourcePolicy, LastSeenAt

GeoCache
IP primary key, CountryCode, Country, Region, City, ASN, ISP, Lat, Lon, RawJson optional, LastUpdated, NextRetryAt

Policy
Single row or key value store for thresholds and lists

Audit
ActionId, Time, Actor, ActionType, Target, Details
Actor can be LocalUser or GUI session

9.2 Retention

Attempts retention default 30 days configurable

GeoCache retention default 30 days refresh on demand

Bans retention default 180 days for history

ipwhois.io integration with free plan fallback

This is the critical part you called out.

10.1 Requirements

Free plan limited requests must not cause crashes.

If rate limit hit or service down, enrichment should degrade gracefully.

Service must continue blocking based on IP and subnet even with zero enrichment.

Allow optional API key to increase limits.

10.2 Configuration

IpWhoisApiKey optional

IpWhoisBaseUrl default https://ipwhois.io

EnrichmentEnabled default true

EnrichmentMaxPerMinute default conservative such as 20 when no key

EnrichmentMaxPerMinuteWithKey configurable

CacheTtlDays default 30

FailureBackoff schedule

10.3 Enrichment workflow

When a new IP is observed, check GeoCache.

If fresh, use cached data.

If missing or stale, enqueue enrichment job.

Enrichment worker processes jobs using rate limiter and circuit breaker.

10.4 Rate limiting strategy

Token bucket limiter per minute

Separate limits for keyed and unkeyed mode

Hard cap to avoid accidental runaway, even with a key

10.5 Retry and backoff strategy

If request fails with network error or timeout, retry with exponential backoff
Example 1 minute, 5 minutes, 30 minutes, 6 hours

If response indicates rate limited or over quota
Mark NextRetryAt to a longer backoff such as 6 hours
Also log a warning once per hour rather than spamming logs

Store failure count in GeoCache so it does not hammer the API

10.6 Circuit breaker

If N consecutive failures occur, open breaker for a cooldown period

During open state, enrichment jobs are deferred, not executed

Service continues detection, bans, GUI operations normally

10.7 Data integrity

If enrichment returns partial data, store what you got and mark it as partial

Never treat missing country as a reason to block by country

Country blocking only applies when country is known and resolved

10.8 Behavior in offline mode

Enrichment worker pauses

GUI shows Unknown for country and ASN

Country stats page notes that enrichment is currently unavailable

Security model

11.1 Privileges

Service requires rights to read Security log and manage firewall rules

Run as LocalSystem by default for simplicity

Option for custom service account with least privilege guidance

11.2 API protection

Bind loopback only

Verify loopback remote endpoint

Require token header such as X RdpReaper Token

Store token using DPAPI protected secret or registry with ACL

GUI runs elevated to manage actions

11.3 Tamper resistance

Signed binaries recommended

Config changes logged to Audit table

Manual ban and unban actions logged

Configuration and deployment

12.1 Install layout

Program files directory for binaries

ProgramData directory for database and logs

Proper ACLs so normal users cannot modify database or config

12.2 Service install

MSI or simple installer

Windows Service recovery options set
Restart on failure, reset failure count daily

12.3 Upgrade strategy

Database migrations handled automatically

Preserve policy and lists across upgrades

Observability and diagnostics

13.1 Health indicators

Last event log read time

Attempt ingestion rate

Active bans count

Firewall sync success timestamp

Enrichment queue depth

Enrichment breaker state and next retry

13.2 Logging

Structured logs with correlation ids for actions

Separate log for firewall operations to simplify troubleshooting

Testing plan

14.1 Unit tests

IP and subnet extraction

Sliding window counter logic

Policy decisions and precedence rules

Rule partition logic

14.2 Integration tests

Simulated event injection

Firewall manager mocked and real environment smoke test

ipwhois client behavior under rate limits and network failures

14.3 Manual validation checklist

Confirm API only accessible on localhost

Confirm bans apply and expire

Confirm subnet bans trigger correctly

Confirm enrichment pauses and recovers gracefully

Initial implementation milestones

Milestone 1 core engine

Event ingestion 4625 type 10

IP threshold banning

SQLite persistence

Firewall rule apply in batches

Basic localhost API status and bans

Milestone 2 enrichment and country blocking

GeoCache table

ipwhois client with limiter and circuit breaker

Country block list and allow list policies

Milestone 3 subnet detection

/24 counters and ban type

GUI display for subnet threats

Milestone 4 GUI modern dashboard

WinUI 3 shell and navigation

Dashboard, Bans, Attempts, Settings, Logs